{% extends 'core/base.html' %}
{% block title %}Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†{% endblock %}
{% block content %}
<section>
  <h2 style="margin-top:0">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† {% if total_count %}({{ total_count }}){% endif %}</h2>
  
  <!-- Search Form -->
  <form method="get" style="margin-bottom: 1.5rem;">
    <div class="row" style="gap: 0.5rem;">
      <input 
        type="search" 
        name="q" 
        value="{{ query }}" 
        placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..." 
        style="flex: 1; padding: 0.75rem;"
        autofocus
      >
      <button type="submit" class="btn">Ø¨Ø­Ø«</button>
      {% if query %}
        <a href="{% url 'accounts:users_list' %}" class="btn" style="background: #ccc;">Ù…Ø³Ø­</a>
      {% endif %}
    </div>
  </form>
  
  {% if query and not users %}
    <p class="muted" style="text-align: center; padding: 2rem;">
      Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø¨Ø­Ø« "{{ query }}"
    </p>
  {% elif users %}
    <ul class="card-list">
      {% for user in users %}
        <li class="card">
          <div style="flex: 1;">
            <strong>{{ user.profile.name }}</strong>
            <div class="muted">{{ user.profile.phone }}</div>
            
            {% if user.is_friend %}
              <span style="color: #25D366; font-size: 0.85rem;">âœ“ ØµØ¯ÙŠÙ‚</span>
            {% elif user.friendship %}
              {% if user.friendship.status == 'pending' %}
                {% if user.friendship.from_user == request.user %}
                  <span style="color: #888; font-size: 0.85rem;">â³ Ø·Ù„Ø¨ Ù…Ø¹Ù„Ù‚</span>
                {% else %}
                  <span style="color: #FF6B6B; font-size: 0.85rem;">ğŸ“¬ Ø·Ù„Ø¨ ØµØ¯Ø§Ù‚Ø© Ø¬Ø¯ÙŠØ¯!</span>
                {% endif %}
              {% elif user.friendship.status == 'blocked' %}
                <span style="color: #FF6B6B; font-size: 0.85rem;">ğŸš« Ù…Ø­Ø¸ÙˆØ±</span>
              {% endif %}
            {% endif %}
          </div>
          
          <div class="row" style="gap: 0.5rem;">
            <a class="btn" href="{% url 'core:dm_thread' user_id=user.id %}" title="Ø¯Ø±Ø¯Ø´Ø©">ğŸ’¬</a>
            
            {% if user.is_blocked %}
              <!-- Ù…Ø­Ø¸ÙˆØ± -->
              <form method="post" action="{% url 'accounts:unblock_user' user_id=user.id %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn" style="background: #888;" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±">ğŸ”“ Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</button>
              </form>
            {% elif user.is_friend %}
              <!-- ØµØ¯ÙŠÙ‚ -->
              <form method="post" action="{% url 'accounts:remove_friend' user_id=user.id %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn" style="background: #FF6B6B;" title="Ø¥Ø²Ø§Ù„Ø© ØµØ¯ÙŠÙ‚" onclick="return confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø²Ø§Ù„Ø© Ù‡Ø°Ø§ Ø§Ù„ØµØ¯ÙŠÙ‚ØŸ')">âŒ</button>
              </form>
            {% elif user.friendship %}
              {% if user.friendship.status == 'pending' %}
                {% if user.friendship.from_user == request.user %}
                  <!-- Ø·Ù„Ø¨ Ù…Ø¹Ù„Ù‚ Ù…Ø±Ø³Ù„ -->
                  <form method="post" action="{% url 'accounts:cancel_friend_request' friendship_id=user.friendship.id %}" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" class="btn" style="background: #888;" title="Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø·Ù„Ø¨">â³ Ø¥Ù„ØºØ§Ø¡</button>
                  </form>
                {% else %}
                  <!-- Ø·Ù„Ø¨ Ù…Ø¹Ù„Ù‚ Ù…Ø³ØªÙ„Ù… -->
                  <form method="post" action="{% url 'accounts:accept_friend_request' friendship_id=user.friendship.id %}" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" class="btn" style="background: #25D366;" title="Ù‚Ø¨ÙˆÙ„">âœ“ Ù‚Ø¨ÙˆÙ„</button>
                  </form>
                  <form method="post" action="{% url 'accounts:reject_friend_request' friendship_id=user.friendship.id %}" style="margin: 0;">
                    {% csrf_token %}
                    <button type="submit" class="btn" style="background: #FF6B6B;" title="Ø±ÙØ¶">âœ— Ø±ÙØ¶</button>
                  </form>
                {% endif %}
              {% endif %}
            {% else %}
              <!-- Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù„Ø§Ù‚Ø© -->
              <form method="post" action="{% url 'accounts:send_friend_request' user_id=user.id %}" style="margin: 0;">
                {% csrf_token %}
                <button type="submit" class="btn" style="background: #128C7E;" title="Ø¥Ø¶Ø§ÙØ© ØµØ¯ÙŠÙ‚">ğŸ‘¥ Ø¥Ø¶Ø§ÙØ©</button>
              </form>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>
    
    <!-- Pagination -->
    {% if users.has_other_pages %}
      <div class="pagination" style="margin-top: 1.5rem; text-align: center;">
        {% if users.has_previous %}
          <a href="?page={{ users.previous_page_number }}{% if query %}&q={{ query }}{% endif %}" class="btn">Ø§Ù„Ø³Ø§Ø¨Ù‚</a>
        {% endif %}
        
        <span style="margin: 0 1rem;">ØµÙØ­Ø© {{ users.number }} Ù…Ù† {{ users.paginator.num_pages }}</span>
        
        {% if users.has_next %}
          <a href="?page={{ users.next_page_number }}{% if query %}&q={{ query }}{% endif %}" class="btn">Ø§Ù„ØªØ§Ù„ÙŠ</a>
        {% endif %}
      </div>
    {% endif %}
  {% else %}
    <p class="muted" style="text-align: center; padding: 2rem;">
      Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø­Ø§Ù„ÙŠØ§Ù‹.
    </p>
  {% endif %}
  
  <div style="margin-top: 2rem; text-align: center;">
    <a href="{% url 'accounts:contacts_sync' %}" class="btn" style="background: #128C7E;">
      ğŸ“± Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ù‡Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„
    </a>
  </div>
</section>
{% endblock %}

